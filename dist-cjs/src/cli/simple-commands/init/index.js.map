{"version":3,"sources":["../../../../../src/cli/simple-commands/init/index.js"],"sourcesContent":["// init/index.js - Initialize Claude Code integration files\nimport { printSuccess, printError, printWarning, exit } from '../../utils.js';\nimport { existsSync } from 'fs';\nimport process from 'process';\nimport { spawn, execSync } from 'child_process';\nimport { promisify } from 'util';\n\n// Helper to replace Deno.Command\nfunction runCommand(command, args, options = {}) {\n  return new Promise((resolve, reject) => {\n    const child = spawn(command, args, {\n      cwd: options.cwd,\n      env: { ...process.env, ...options.env },\n      stdio: options.stdout === 'inherit' ? 'inherit' : 'pipe'\n    });\n    \n    let stdout = '';\n    let stderr = '';\n    \n    if (options.stdout !== 'inherit') {\n      child.stdout.on('data', (data) => { stdout += data; });\n      child.stderr.on('data', (data) => { stderr += data; });\n    }\n    \n    child.on('close', (code) => {\n      if (code === 0) {\n        resolve({ success: true, code, stdout, stderr });\n      } else {\n        reject(new Error(`Command failed with exit code ${code}`));\n      }\n    });\n    \n    child.on('error', reject);\n  });\n}\nimport { createLocalExecutable } from './executable-wrapper.js';\nimport { createSparcStructureManually } from './sparc-structure.js';\nimport { createClaudeSlashCommands } from './claude-commands/slash-commands.js';\nimport { createOptimizedClaudeSlashCommands } from './claude-commands/optimized-slash-commands.js';\n// execSync imported above as execSyncOriginal\\nconst execSync = execSyncOriginal;\nimport { promises as fs } from 'fs';\nimport { copyTemplates } from './template-copier.js';\nimport { copyRevisedTemplates, validateTemplatesExist } from './copy-revised-templates.js';\nimport { copyAgentFiles, createAgentDirectories, validateAgentSystem, copyCommandFiles } from './agent-copier.js';\nimport { showInitHelp } from './help.js';\nimport { batchInitCommand, batchInitFromConfig, validateBatchOptions } from './batch-init.js';\nimport { ValidationSystem, runFullValidation } from './validation/index.js';\nimport { RollbackSystem, createAtomicOperation } from './rollback/index.js';\nimport {\n  createEnhancedClaudeMd,\n  createEnhancedSettingsJson,\n  createWrapperScript,\n  createCommandDoc,\n  createHelperScript,\n  COMMAND_STRUCTURE,\n} from './templates/enhanced-templates.js';\nimport { createOptimizedSparcClaudeMd } from './templates/claude-md.js';\nimport { getIsolatedNpxEnv } from '../../../utils/npx-isolated-cache.js';\nimport { updateGitignore, needsGitignoreUpdate } from './gitignore-updater.js';\nimport {\n  createFullClaudeMd,\n  createSparcClaudeMd,\n  createMinimalClaudeMd,\n} from './templates/claude-md.js';\nimport {\n  createVerificationClaudeMd,\n  createVerificationSettingsJson,\n} from './templates/verification-claude-md.js';\nimport {\n  createFullMemoryBankMd,\n  createMinimalMemoryBankMd,\n} from './templates/memory-bank-md.js';\nimport {\n  createFullCoordinationMd,\n  createMinimalCoordinationMd,\n} from './templates/coordination-md.js';\nimport { createAgentsReadme, createSessionsReadme } from './templates/readme-files.js';\nimport { \n  initializeHiveMind, \n  getHiveMindStatus,\n  rollbackHiveMindInit\n} from './hive-mind-init.js';\n\n/**\n * Check if Claude Code CLI is installed\n */\nfunction isClaudeCodeInstalled() {\n  try {\n    execSync('which claude', { stdio: 'ignore' });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Set up MCP servers in Claude Code\n */\nasync function setupMcpServers(dryRun = false) {\n  console.log('\\nüîå Setting up MCP servers for Claude Code...');\n\n  const servers = [\n    {\n      name: 'claude-flow',\n      command: 'npx claude-flow@alpha mcp start',\n      description: 'Claude Flow MCP server with swarm orchestration (alpha)',\n    },\n    {\n      name: 'ruv-swarm',\n      command: 'npx ruv-swarm mcp start',\n      description: 'ruv-swarm MCP server for enhanced coordination',\n    },\n    {\n      name: 'flow-nexus',\n      command: 'npx flow-nexus@latest mcp start',\n      description: 'Flow Nexus Complete MCP server for advanced AI orchestration',\n    },\n  ];\n\n  for (const server of servers) {\n    try {\n      if (!dryRun) {\n        console.log(`  üîÑ Adding ${server.name}...`);\n        execSync(`claude mcp add ${server.name} ${server.command}`, { stdio: 'inherit' });\n        console.log(`  ‚úÖ Added ${server.name} - ${server.description}`);\n      } else {\n        console.log(`  [DRY RUN] Would add ${server.name} - ${server.description}`);\n      }\n    } catch (err) {\n      console.log(`  ‚ö†Ô∏è  Failed to add ${server.name}: ${err.message}`);\n      console.log(\n        `     You can add it manually with: claude mcp add ${server.name} ${server.command}`,\n      );\n    }\n  }\n\n  if (!dryRun) {\n    console.log('\\n  üìã Verifying MCP servers...');\n    try {\n      execSync('claude mcp list', { stdio: 'inherit' });\n    } catch (err) {\n      console.log('  ‚ö†Ô∏è  Could not verify MCP servers');\n    }\n  }\n}\n\nexport async function initCommand(subArgs, flags) {\n  // Show help if requested\n  if (flags.help || flags.h || subArgs.includes('--help') || subArgs.includes('-h')) {\n    showInitHelp();\n    return;\n  }\n\n  // Check for verification flags first\n  const hasVerificationFlags = subArgs.includes('--verify') || subArgs.includes('--pair') || \n                               flags.verify || flags.pair;\n  \n  // Handle Flow Nexus minimal init\n  if (flags['flow-nexus']) {\n    return await flowNexusMinimalInit(flags, subArgs);\n  }\n\n  // Default to enhanced Claude Flow v2 init unless other modes are specified\n  // Use --basic flag for old behavior, or verification flags for verification mode\n  if (!flags.basic && !flags.minimal && !flags.sparc && !hasVerificationFlags) {\n    return await enhancedClaudeFlowInit(flags, subArgs);\n  }\n\n  // Check for validation and rollback commands\n  if (subArgs.includes('--validate') || subArgs.includes('--validate-only')) {\n    return handleValidationCommand(subArgs, flags);\n  }\n\n  if (subArgs.includes('--rollback')) {\n    return handleRollbackCommand(subArgs, flags);\n  }\n\n  if (subArgs.includes('--list-backups')) {\n    return handleListBackups(subArgs, flags);\n  }\n\n  // Check for batch operations\n  const batchInitFlag = flags['batch-init'] || subArgs.includes('--batch-init');\n  const configFlag = flags.config || subArgs.includes('--config');\n\n  if (batchInitFlag || configFlag) {\n    return handleBatchInit(subArgs, flags);\n  }\n\n  // Check if enhanced initialization is requested\n  const useEnhanced = subArgs.includes('--enhanced') || subArgs.includes('--safe');\n\n  if (useEnhanced) {\n    return enhancedInitCommand(subArgs, flags);\n  }\n\n  // Parse init options\n  const initForce = subArgs.includes('--force') || subArgs.includes('-f') || flags.force;\n  const initMinimal = subArgs.includes('--minimal') || subArgs.includes('-m') || flags.minimal;\n  const initSparc = flags.roo || (subArgs && subArgs.includes('--roo')); // SPARC only with --roo flag\n  const initDryRun = subArgs.includes('--dry-run') || subArgs.includes('-d') || flags.dryRun;\n  const initOptimized = initSparc && initForce; // Use optimized templates when both flags are present\n  const selectedModes = flags.modes ? flags.modes.split(',') : null; // Support selective mode initialization\n  \n  // Check for verification and pair programming flags\n  const initVerify = subArgs.includes('--verify') || flags.verify;\n  const initPair = subArgs.includes('--pair') || flags.pair;\n\n  // Get the actual working directory (where the command was run from)\n  // Use PWD environment variable which preserves the original directory\n  const workingDir = process.env.PWD || cwd();\n  console.log(`üìÅ Initializing in: ${workingDir}`);\n\n  // Change to the working directory to ensure all file operations happen there\n  try {\n    process.chdir(workingDir);\n  } catch (err) {\n    printWarning(`Could not change to directory ${workingDir}: ${err.message}`);\n  }\n\n  try {\n    printSuccess('Initializing Claude Code integration files...');\n\n    // Check if files already exist in the working directory\n    const files = ['CLAUDE.md', 'memory-bank.md', 'coordination.md'];\n    const existingFiles = [];\n\n    for (const file of files) {\n      try {\n        await fs.stat(`${workingDir}/${file}`);\n        existingFiles.push(file);\n      } catch {\n        // File doesn't exist, which is what we want\n      }\n    }\n\n    if (existingFiles.length > 0 && !initForce) {\n      printWarning(`The following files already exist: ${existingFiles.join(', ')}`);\n      console.log('Use --force to overwrite existing files');\n      return;\n    }\n\n    // Use template copier to copy all template files\n    const templateOptions = {\n      sparc: initSparc,\n      minimal: initMinimal,\n      optimized: initOptimized,\n      dryRun: initDryRun,\n      force: initForce,\n      selectedModes: selectedModes,\n      verify: initVerify,\n      pair: initPair,\n    };\n\n    // If verification flags are set, always use generated templates for CLAUDE.md and settings.json\n    if (initVerify || initPair) {\n      console.log('  üìÅ Creating verification-focused configuration...');\n      \n      // Create verification CLAUDE.md\n      if (!initDryRun) {\n        const { createVerificationClaudeMd, createVerificationSettingsJson } = await import('./templates/verification-claude-md.js');\n        await fs.writeFile(`${workingDir}/CLAUDE.md`, createVerificationClaudeMd(), 'utf8');\n        \n        // Create .claude directory and settings\n        await fs.mkdir(`${workingDir}/.claude`, { recursive: true });\n        await fs.writeFile(`${workingDir}/.claude/settings.json`, createVerificationSettingsJson(), 'utf8');\n        console.log('  ‚úÖ Created verification-focused CLAUDE.md and settings.json');\n      } else {\n        console.log('  [DRY RUN] Would create verification-focused CLAUDE.md and settings.json');\n      }\n      \n      // Copy other template files from repository if available\n      const validation = validateTemplatesExist();\n      if (validation.valid) {\n        const revisedResults = await copyRevisedTemplates(workingDir, {\n          force: initForce,\n          dryRun: initDryRun,\n          verbose: false,\n          sparc: initSparc\n        });\n      }\n      \n      // Also create standard memory and coordination files\n      const copyResults = await copyTemplates(workingDir, {\n        ...templateOptions,\n        skipClaudeMd: true,  // Don't overwrite the verification CLAUDE.md\n        skipSettings: true   // Don't overwrite the verification settings.json\n      });\n      \n    } else {\n      // Standard template copying logic\n      const validation = validateTemplatesExist();\n      if (validation.valid) {\n        console.log('  üìÅ Copying revised template files...');\n        const revisedResults = await copyRevisedTemplates(workingDir, {\n          force: initForce,\n          dryRun: initDryRun,\n          verbose: true,\n          sparc: initSparc\n        });\n\n        if (revisedResults.success) {\n          console.log(`  ‚úÖ Copied ${revisedResults.copiedFiles.length} template files`);\n          if (revisedResults.skippedFiles.length > 0) {\n            console.log(`  ‚è≠Ô∏è  Skipped ${revisedResults.skippedFiles.length} existing files`);\n          }\n        } else {\n          console.log('  ‚ö†Ô∏è  Some template files could not be copied:');\n          revisedResults.errors.forEach(err => console.log(`    - ${err}`));\n        }\n      } else {\n        // Fall back to generated templates\n        console.log('  ‚ö†Ô∏è  Revised templates not available, using generated templates');\n        const copyResults = await copyTemplates(workingDir, templateOptions);\n\n        if (!copyResults.success) {\n          printError('Failed to copy templates:');\n          copyResults.errors.forEach(err => console.log(`  ‚ùå ${err}`));\n          return;\n        }\n      }\n    }\n\n    // Agent setup moved to end of function where execution is guaranteed\n\n    // Directory structure is created by template copier\n\n    // SPARC files are created by template copier when --sparc flag is used\n\n    // Memory README files and persistence database are created by template copier\n\n    // Create local claude-flow@alpha executable wrapper\n    if (!initDryRun) {\n      await createLocalExecutable(workingDir);\n    } else {\n      console.log('  [DRY RUN] Would create local claude-flow@alpha executable wrapper');\n    }\n\n    // SPARC initialization\n    if (initSparc) {\n      console.log('\\nüöÄ Initializing SPARC development environment...');\n\n      if (initDryRun) {\n        console.log('  [DRY RUN] Would run: npx -y create-sparc init --force');\n        console.log('  [DRY RUN] Would create SPARC environment with all modes');\n        console.log(\n          '  [DRY RUN] Would create Claude slash commands' +\n            (initOptimized ? ' (Batchtools-optimized)' : ''),\n        );\n        if (selectedModes) {\n          console.log(\n            `  [DRY RUN] Would create commands for selected modes: ${selectedModes.join(', ')}`,\n          );\n        }\n      } else {\n        // Check if create-sparc exists and run it\n        let sparcInitialized = false;\n        try {\n          // Use isolated NPX cache to prevent concurrent conflicts\n          console.log('  üîÑ Running: npx -y create-sparc init --force');\n          const createSparcResult = await runCommand('npx', ['-y', 'create-sparc', 'init', '--force'], {\n            cwd: workingDir,\n            stdout: 'inherit',\n            stderr: 'inherit',\n            env: getIsolatedNpxEnv({\n              PWD: workingDir,\n            }),\n          });\n\n          if (createSparcResult.success) {\n            console.log('  ‚úÖ SPARC environment initialized successfully');\n            sparcInitialized = true;\n          } else {\n            printWarning('create-sparc failed, creating basic SPARC structure manually...');\n\n            // Fallback: create basic SPARC structure manually\n            await createSparcStructureManually();\n            sparcInitialized = true; // Manual creation still counts as initialized\n          }\n        } catch (err) {\n          printWarning('create-sparc not available, creating basic SPARC structure manually...');\n\n          // Fallback: create basic SPARC structure manually\n          await createSparcStructureManually();\n          sparcInitialized = true; // Manual creation still counts as initialized\n        }\n\n        // Always create Claude slash commands after SPARC initialization\n        if (sparcInitialized) {\n          try {\n            if (initOptimized) {\n              await createOptimizedClaudeSlashCommands(workingDir, selectedModes);\n            } else {\n              await createClaudeSlashCommands(workingDir);\n            }\n          } catch (err) {\n            // Legacy slash command creation - silently skip if it fails\n            // SPARC slash commands are already created successfully above\n          }\n        }\n      }\n    }\n\n    if (initDryRun) {\n      printSuccess(\"üîç Dry run completed! Here's what would be created:\");\n      console.log('\\nüìã Summary of planned initialization:');\n      console.log(\n        `  ‚Ä¢ Configuration: ${initOptimized ? 'Batchtools-optimized SPARC' : initSparc ? 'SPARC-enhanced' : 'Standard'}`,\n      );\n      console.log(\n        `  ‚Ä¢ Template type: ${initOptimized ? 'Optimized for parallel processing' : 'Standard'}`,\n      );\n      console.log('  ‚Ä¢ Core files: CLAUDE.md, memory-bank.md, coordination.md');\n      console.log('  ‚Ä¢ Directory structure: memory/, coordination/, .claude/');\n      console.log('  ‚Ä¢ Local executable: ./claude-flow@alpha');\n      if (initSparc) {\n        console.log(\n          `  ‚Ä¢ Claude Code slash commands: ${selectedModes ? selectedModes.length : 'All'} SPARC mode commands`,\n        );\n        console.log('  ‚Ä¢ SPARC environment with all development modes');\n      }\n      if (initOptimized) {\n        console.log('  ‚Ä¢ Batchtools optimization: Enabled for parallel processing');\n        console.log('  ‚Ä¢ Performance enhancements: Smart batching, concurrent operations');\n      }\n      console.log('\\nüöÄ To proceed with initialization, run the same command without --dry-run');\n    } else {\n      printSuccess('üéâ Claude Code integration files initialized successfully!');\n\n      if (initOptimized) {\n        console.log('\\n‚ö° Batchtools Optimization Enabled!');\n        console.log('  ‚Ä¢ Parallel processing capabilities activated');\n        console.log('  ‚Ä¢ Performance improvements: 250-500% faster operations');\n        console.log('  ‚Ä¢ Smart batching and concurrent operations available');\n      }\n\n      console.log('\\nüìã What was created:');\n      console.log(\n        `  ‚úÖ CLAUDE.md (${initOptimized ? 'Batchtools-optimized' : initSparc ? 'SPARC-enhanced' : 'Standard configuration'})`,\n      );\n      console.log(\n        `  ‚úÖ memory-bank.md (${initOptimized ? 'With parallel processing' : 'Standard memory system'})`,\n      );\n      console.log(\n        `  ‚úÖ coordination.md (${initOptimized ? 'Enhanced with batchtools' : 'Standard coordination'})`,\n      );\n      console.log('  ‚úÖ Directory structure with memory/ and coordination/');\n      console.log('  ‚úÖ Local executable at ./claude-flow@alpha');\n      console.log('  ‚úÖ Persistence database at memory/claude-flow@alpha-data.json');\n      console.log('  ‚úÖ Agent system with 64 specialized agents in .claude/agents/');\n\n      if (initSparc) {\n        const modeCount = selectedModes ? selectedModes.length : '20+';\n        console.log(`  ‚úÖ Claude Code slash commands (${modeCount} SPARC modes)`);\n        console.log('  ‚úÖ Complete SPARC development environment');\n      }\n\n      console.log('\\nüöÄ Next steps:');\n      console.log('1. Review and customize the generated files for your project');\n      console.log(\"2. Run './claude-flow@alpha start' to begin the orchestration system\");\n      console.log(\"3. Use './claude-flow@alpha' instead of 'npx claude-flow@alpha' for all commands\");\n      console.log(\"4. Use 'claude --dangerously-skip-permissions' for unattended operation\");\n\n      if (initSparc) {\n        console.log(\n          '5. Use Claude Code slash commands: /sparc, /sparc-architect, /sparc-tdd, etc.',\n        );\n        console.log(\"6. Explore SPARC modes with './claude-flow@alpha sparc modes'\");\n        console.log('7. Try TDD workflow with \\'./claude-flow@alpha sparc tdd \"your task\"\\'');\n\n        if (initOptimized) {\n          console.log('8. Use batchtools commands: /batchtools, /performance for optimization');\n          console.log('9. Enable parallel processing with --parallel flags');\n          console.log(\"10. Monitor performance with './claude-flow@alpha performance monitor'\");\n        }\n      }\n\n      // Update .gitignore\n      const gitignoreResult = await updateGitignore(workingDir, initForce, initDryRun);\n      if (gitignoreResult.success) {\n        if (!initDryRun) {\n          console.log(`  ‚úÖ ${gitignoreResult.message}`);\n        } else {\n          console.log(`  ${gitignoreResult.message}`);\n        }\n      } else {\n        console.log(`  ‚ö†Ô∏è  ${gitignoreResult.message}`);\n      }\n\n      console.log('\\nüí° Tips:');\n      console.log(\"  ‚Ä¢ Type '/' in Claude Code to see all available slash commands\");\n      console.log(\"  ‚Ä¢ Use './claude-flow@alpha status' to check system health\");\n      console.log(\"  ‚Ä¢ Store important context with './claude-flow@alpha memory store'\");\n\n      if (initOptimized) {\n        console.log('  ‚Ä¢ Use --parallel flags for concurrent operations');\n        console.log('  ‚Ä¢ Enable batch processing for multiple related tasks');\n        console.log('  ‚Ä¢ Monitor performance with real-time metrics');\n      }\n\n      // Initialize hive-mind system for standard init\n      console.log('\\nüß† Initializing basic hive-mind system...');\n      try {\n        const hiveMindOptions = {\n          config: {\n            integration: {\n              claudeCode: { enabled: isClaudeCodeInstalled() },\n              mcpTools: { enabled: true }\n            },\n            monitoring: { enabled: false } // Basic setup for standard init\n          }\n        };\n        \n        const hiveMindResult = await initializeHiveMind(workingDir, hiveMindOptions, false);\n        \n        if (hiveMindResult.success) {\n          console.log('  ‚úÖ Basic hive-mind system initialized');\n          console.log('  üí° Use \"npx claude-flow@alpha hive-mind\" for advanced features');\n        } else {\n          console.log(`  ‚ö†Ô∏è  Hive-mind setup skipped: ${hiveMindResult.error}`);\n        }\n      } catch (err) {\n        console.log(`  ‚ö†Ô∏è  Hive-mind setup skipped: ${err.message}`);\n      }\n\n      // Check for Claude Code and set up MCP servers (always enabled by default)\n      if (!initDryRun && isClaudeCodeInstalled()) {\n        console.log('\\nüîç Claude Code CLI detected!');\n        const skipMcp = subArgs && subArgs.includes && subArgs.includes('--skip-mcp');\n\n        if (!skipMcp) {\n          await setupMcpServers(initDryRun);\n        } else {\n          console.log('  ‚ÑπÔ∏è  Skipping MCP setup (--skip-mcp flag used)');\n        }\n      } else if (!initDryRun && !isClaudeCodeInstalled()) {\n        console.log('\\n‚ö†Ô∏è  Claude Code CLI not detected!');\n        console.log('  üì• Install with: npm install -g @anthropic-ai/claude-code');\n        console.log('  üìã Then add MCP servers manually with:');\n        console.log('     claude mcp add claude-flow npx claude-flow@alpha mcp start');\n        console.log('     claude mcp add ruv-swarm npx ruv-swarm mcp start');\n        console.log('     claude mcp add flow-nexus npx flow-nexus@latest mcp start');\n      }\n    }\n  } catch (err) {\n    printError(`Failed to initialize files: ${err.message}`);\n  }\n}\n\n// Handle batch initialization\nasync function handleBatchInit(subArgs, flags) {\n  try {\n    // Options parsing from flags and subArgs\n    const options = {\n      parallel: !flags['no-parallel'] && flags.parallel !== false,\n      sparc: flags.sparc || flags.s,\n      minimal: flags.minimal || flags.m,\n      force: flags.force || flags.f,\n      maxConcurrency: flags['max-concurrent'] || 5,\n      progressTracking: true,\n      template: flags.template,\n      environments: flags.environments\n        ? flags.environments.split(',').map((env) => env.trim())\n        : ['dev'],\n    };\n\n    // Validate options\n    const validationErrors = validateBatchOptions(options);\n    if (validationErrors.length > 0) {\n      printError('Batch options validation failed:');\n      validationErrors.forEach((error) => console.error(`  - ${error}`));\n      return;\n    }\n\n    // Config file mode\n    if (flags.config) {\n      const configFile = flags.config;\n      printSuccess(`Loading batch configuration from: ${configFile}`);\n      const results = await batchInitFromConfig(configFile, options);\n      if (results) {\n        printSuccess('Batch initialization from config completed');\n      }\n      return;\n    }\n\n    // Batch init mode\n    if (flags['batch-init']) {\n      const projectsString = flags['batch-init'];\n      const projects = projectsString.split(',').map((project) => project.trim());\n\n      if (projects.length === 0) {\n        printError('No projects specified for batch initialization');\n        return;\n      }\n\n      printSuccess(`Initializing ${projects.length} projects in batch mode`);\n      const results = await batchInitCommand(projects, options);\n\n      if (results) {\n        const successful = results.filter((r) => r.success).length;\n        const failed = results.filter((r) => !r.success).length;\n\n        if (failed === 0) {\n          printSuccess(`All ${successful} projects initialized successfully`);\n        } else {\n          printWarning(`${successful} projects succeeded, ${failed} failed`);\n        }\n      }\n      return;\n    }\n\n    printError('No batch operation specified. Use --batch-init <projects> or --config <file>');\n  } catch (err) {\n    printError(`Batch initialization failed: ${err.message}`);\n  }\n}\n\n/**\n * Enhanced initialization command with validation and rollback\n */\nasync function enhancedInitCommand(subArgs, flags) {\n  console.log('üõ°Ô∏è  Starting enhanced initialization with validation and rollback...');\n\n  // Store parameters to avoid scope issues in async context\n  const args = subArgs || [];\n  const options = flags || {};\n\n  // Get the working directory\n  const workingDir = process.env.PWD || process.cwd();\n\n  // Initialize systems\n  const rollbackSystem = new RollbackSystem(workingDir);\n  const validationSystem = new ValidationSystem(workingDir);\n\n  let atomicOp = null;\n\n  try {\n    // Parse options\n    const initOptions = {\n      force: args.includes('--force') || args.includes('-f') || options.force,\n      minimal: args.includes('--minimal') || args.includes('-m') || options.minimal,\n      sparc: args.includes('--sparc') || args.includes('-s') || options.sparc,\n      skipPreValidation: args.includes('--skip-pre-validation'),\n      skipBackup: args.includes('--skip-backup'),\n      validateOnly: args.includes('--validate-only'),\n    };\n\n    // Phase 1: Pre-initialization validation\n    if (!initOptions.skipPreValidation) {\n      console.log('\\nüîç Phase 1: Pre-initialization validation...');\n      const preValidation = await validationSystem.validatePreInit(initOptions);\n\n      if (!preValidation.success) {\n        printError('Pre-initialization validation failed:');\n        preValidation.errors.forEach((error) => console.error(`  ‚ùå ${error}`));\n        return;\n      }\n\n      if (preValidation.warnings.length > 0) {\n        printWarning('Pre-initialization warnings:');\n        preValidation.warnings.forEach((warning) => console.warn(`  ‚ö†Ô∏è  ${warning}`));\n      }\n\n      printSuccess('Pre-initialization validation passed');\n    }\n\n    // Stop here if validation-only mode\n    if (options.validateOnly) {\n      console.log('\\n‚úÖ Validation-only mode completed');\n      return;\n    }\n\n    // Phase 2: Create backup\n    if (!options.skipBackup) {\n      console.log('\\nüíæ Phase 2: Creating backup...');\n      const backupResult = await rollbackSystem.createPreInitBackup();\n\n      if (!backupResult.success) {\n        printError('Backup creation failed:');\n        backupResult.errors.forEach((error) => console.error(`  ‚ùå ${error}`));\n        return;\n      }\n    }\n\n    // Phase 3: Initialize with atomic operations\n    console.log('\\nüîß Phase 3: Atomic initialization...');\n    atomicOp = createAtomicOperation(rollbackSystem, 'enhanced-init');\n\n    const atomicBegin = await atomicOp.begin();\n    if (!atomicBegin) {\n      printError('Failed to begin atomic operation');\n      return;\n    }\n\n    // Perform initialization steps with checkpoints\n    await performInitializationWithCheckpoints(rollbackSystem, options, workingDir, dryRun);\n\n    // Phase 4: Post-initialization validation\n    console.log('\\n‚úÖ Phase 4: Post-initialization validation...');\n    const postValidation = await validationSystem.validatePostInit();\n\n    if (!postValidation.success) {\n      printError('Post-initialization validation failed:');\n      postValidation.errors.forEach((error) => console.error(`  ‚ùå ${error}`));\n\n      // Attempt automatic rollback\n      console.log('\\nüîÑ Attempting automatic rollback...');\n      await atomicOp.rollback();\n      printWarning('Initialization rolled back due to validation failure');\n      return;\n    }\n\n    // Phase 5: Configuration validation\n    console.log('\\nüîß Phase 5: Configuration validation...');\n    const configValidation = await validationSystem.validateConfiguration();\n\n    if (configValidation.warnings.length > 0) {\n      printWarning('Configuration warnings:');\n      configValidation.warnings.forEach((warning) => console.warn(`  ‚ö†Ô∏è  ${warning}`));\n    }\n\n    // Phase 6: Health checks\n    console.log('\\nüè• Phase 6: System health checks...');\n    const healthChecks = await validationSystem.runHealthChecks();\n\n    if (healthChecks.warnings.length > 0) {\n      printWarning('Health check warnings:');\n      healthChecks.warnings.forEach((warning) => console.warn(`  ‚ö†Ô∏è  ${warning}`));\n    }\n\n    // Commit atomic operation\n    await atomicOp.commit();\n\n    // Generate and display validation report\n    const fullValidation = await runFullValidation(workingDir, {\n      postInit: true,\n      skipPreInit: options.skipPreValidation,\n    });\n\n    console.log('\\nüìä Validation Report:');\n    console.log(fullValidation.report);\n\n    printSuccess('üéâ Enhanced initialization completed successfully!');\n    console.log('\\n‚ú® Your SPARC environment is fully validated and ready to use');\n  } catch (error) {\n    printError(`Enhanced initialization failed: ${error.message}`);\n\n    // Attempt rollback if atomic operation is active\n    if (atomicOp && !atomicOp.completed) {\n      console.log('\\nüîÑ Performing emergency rollback...');\n      try {\n        await atomicOp.rollback();\n        printWarning('Emergency rollback completed');\n      } catch (rollbackError) {\n        printError(`Rollback also failed: ${rollbackError.message}`);\n      }\n    }\n  }\n}\n\n/**\n * Handle validation commands\n */\nasync function handleValidationCommand(subArgs, flags) {\n  const workingDir = process.env.PWD || process.cwd();\n\n  console.log('üîç Running validation checks...');\n\n  const options = {\n    skipPreInit: subArgs.includes('--skip-pre-init'),\n    skipConfig: subArgs.includes('--skip-config'),\n    skipModeTest: subArgs.includes('--skip-mode-test'),\n    postInit: !subArgs.includes('--pre-init-only'),\n  };\n\n  try {\n    const validationResults = await runFullValidation(workingDir, options);\n\n    console.log('\\nüìä Validation Results:');\n    console.log(validationResults.report);\n\n    if (validationResults.success) {\n      printSuccess('‚úÖ All validation checks passed');\n    } else {\n      printError('‚ùå Some validation checks failed');\n      process.exit(1);\n    }\n  } catch (error) {\n    printError(`Validation failed: ${error.message}`);\n    process.exit(1);\n  }\n}\n\n/**\n * Handle rollback commands\n */\nasync function handleRollbackCommand(subArgs, flags) {\n  const workingDir = process.env.PWD || process.cwd();\n  const rollbackSystem = new RollbackSystem(workingDir);\n\n  try {\n    // Check for specific rollback options\n    if (subArgs.includes('--full')) {\n      console.log('üîÑ Performing full rollback...');\n      const result = await rollbackSystem.performFullRollback();\n\n      if (result.success) {\n        printSuccess('Full rollback completed successfully');\n      } else {\n        printError('Full rollback failed:');\n        result.errors.forEach((error) => console.error(`  ‚ùå ${error}`));\n      }\n    } else if (subArgs.includes('--partial')) {\n      const phaseIndex = subArgs.findIndex((arg) => arg === '--phase');\n      if (phaseIndex !== -1 && subArgs[phaseIndex + 1]) {\n        const phase = subArgs[phaseIndex + 1];\n        console.log(`üîÑ Performing partial rollback for phase: ${phase}`);\n\n        const result = await rollbackSystem.performPartialRollback(phase);\n\n        if (result.success) {\n          printSuccess(`Partial rollback completed for phase: ${phase}`);\n        } else {\n          printError(`Partial rollback failed for phase: ${phase}`);\n          result.errors.forEach((error) => console.error(`  ‚ùå ${error}`));\n        }\n      } else {\n        printError('Partial rollback requires --phase <phase-name>');\n      }\n    } else {\n      // Interactive rollback point selection\n      const rollbackPoints = await rollbackSystem.listRollbackPoints();\n\n      if (rollbackPoints.rollbackPoints.length === 0) {\n        printWarning('No rollback points available');\n        return;\n      }\n\n      console.log('\\nüìã Available rollback points:');\n      rollbackPoints.rollbackPoints.forEach((point, index) => {\n        const date = new Date(point.timestamp).toLocaleString();\n        console.log(`  ${index + 1}. ${point.type} - ${date}`);\n      });\n\n      // For now, rollback to the most recent point\n      const latest = rollbackPoints.rollbackPoints[0];\n      if (latest) {\n        console.log(\n          `\\nüîÑ Rolling back to: ${latest.type} (${new Date(latest.timestamp).toLocaleString()})`,\n        );\n        const result = await rollbackSystem.performFullRollback(latest.backupId);\n\n        if (result.success) {\n          printSuccess('Rollback completed successfully');\n        } else {\n          printError('Rollback failed');\n        }\n      }\n    }\n  } catch (error) {\n    printError(`Rollback operation failed: ${error.message}`);\n  }\n}\n\n/**\n * Handle list backups command\n */\nasync function handleListBackups(subArgs, flags) {\n  const workingDir = process.env.PWD || process.cwd();\n  const rollbackSystem = new RollbackSystem(workingDir);\n\n  try {\n    const rollbackPoints = await rollbackSystem.listRollbackPoints();\n\n    console.log('\\nüìã Rollback Points and Backups:');\n\n    if (rollbackPoints.rollbackPoints.length === 0) {\n      console.log('  No rollback points available');\n    } else {\n      console.log('\\nüîÑ Rollback Points:');\n      rollbackPoints.rollbackPoints.forEach((point, index) => {\n        const date = new Date(point.timestamp).toLocaleString();\n        console.log(`  ${index + 1}. ${point.type} - ${date} (${point.backupId || 'No backup'})`);\n      });\n    }\n\n    if (rollbackPoints.checkpoints.length > 0) {\n      console.log('\\nüìç Checkpoints:');\n      rollbackPoints.checkpoints.slice(-5).forEach((checkpoint, index) => {\n        const date = new Date(checkpoint.timestamp).toLocaleString();\n        console.log(`  ${index + 1}. ${checkpoint.phase} - ${date} (${checkpoint.status})`);\n      });\n    }\n  } catch (error) {\n    printError(`Failed to list backups: ${error.message}`);\n  }\n}\n\n/**\n * Perform initialization with checkpoints\n */\nasync function performInitializationWithCheckpoints(\n  rollbackSystem,\n  options,\n  workingDir,\n  dryRun = false,\n) {\n  const phases = [\n    { name: 'file-creation', action: () => createInitialFiles(options, workingDir, dryRun) },\n    { name: 'directory-structure', action: () => createDirectoryStructure(workingDir, dryRun) },\n    { name: 'memory-setup', action: () => setupMemorySystem(workingDir, dryRun) },\n    { name: 'coordination-setup', action: () => setupCoordinationSystem(workingDir, dryRun) },\n    { name: 'executable-creation', action: () => createLocalExecutable(workingDir, dryRun) },\n  ];\n\n  if (options.sparc) {\n    phases.push(\n      { name: 'sparc-init', action: () => createSparcStructureManually() },\n      { name: 'claude-commands', action: () => createClaudeSlashCommands(workingDir) },\n    );\n  }\n\n  for (const phase of phases) {\n    console.log(`  üîß ${phase.name}...`);\n\n    // Create checkpoint before phase\n    await rollbackSystem.createCheckpoint(phase.name, {\n      timestamp: Date.now(),\n      phase: phase.name,\n    });\n\n    try {\n      await phase.action();\n      console.log(`  ‚úÖ ${phase.name} completed`);\n    } catch (error) {\n      console.error(`  ‚ùå ${phase.name} failed: ${error.message}`);\n      throw error;\n    }\n  }\n}\n\n// Helper functions for atomic initialization\nasync function createInitialFiles(options, workingDir, dryRun = false) {\n  if (!dryRun) {\n    const claudeMd = options.sparc\n      ? createSparcClaudeMd()\n      : options.minimal\n        ? createMinimalClaudeMd()\n        : createFullClaudeMd();\n    await fs.writeFile(`${workingDir}/CLAUDE.md`, claudeMd, 'utf8');\n\n    const memoryBankMd = options.minimal ? createMinimalMemoryBankMd() : createFullMemoryBankMd();\n    await fs.writeFile(`${workingDir}/memory-bank.md`, memoryBankMd, 'utf8');\n\n    const coordinationMd = options.minimal\n      ? createMinimalCoordinationMd()\n      : createFullCoordinationMd();\n    await fs.writeFile(`${workingDir}/coordination.md`, coordinationMd, 'utf8');\n  }\n}\n\nasync function createDirectoryStructure(workingDir, dryRun = false) {\n  const directories = [\n    'memory',\n    'memory/agents',\n    'memory/sessions',\n    'coordination',\n    'coordination/memory_bank',\n    'coordination/subtasks',\n    'coordination/orchestration',\n    '.claude',\n    '.claude/commands',\n    '.claude/logs',\n  ];\n\n  if (!dryRun) {\n    for (const dir of directories) {\n      await fs.mkdir(`${workingDir}/${dir}`, { recursive: true });\n    }\n  }\n}\n\nasync function setupMemorySystem(workingDir, dryRun = false) {\n  if (!dryRun) {\n    const initialData = { agents: [], tasks: [], lastUpdated: Date.now() };\n    await fs.writeFile(\n      `${workingDir}/memory/claude-flow@alpha-data.json`, JSON.stringify(initialData, null, 2), 'utf8'\n    );\n\n    await fs.writeFile(`${workingDir}/memory/agents/README.md`, createAgentsReadme(), 'utf8');\n    await fs.writeFile(`${workingDir}/memory/sessions/README.md`, createSessionsReadme(), 'utf8');\n  }\n}\n\nasync function setupCoordinationSystem(workingDir, dryRun = false) {\n  // Coordination system is already set up by createDirectoryStructure\n  // This is a placeholder for future coordination setup logic\n}\n\n/**\n * Setup monitoring and telemetry for token tracking\n */\nasync function setupMonitoring(workingDir) {\n  console.log('  üìà Configuring token usage tracking...');\n  \n  const fs = await import('fs/promises');\n  const path = await import('path');\n  \n  try {\n    // Create .claude-flow@alpha directory for tracking data\n    const trackingDir = path.join(workingDir, '.claude-flow@alpha');\n    await fs.mkdir(trackingDir, { recursive: true });\n    \n    // Create initial token usage file\n    const tokenUsageFile = path.join(trackingDir, 'token-usage.json');\n    const initialData = {\n      total: 0,\n      input: 0,\n      output: 0,\n      byAgent: {},\n      lastUpdated: new Date().toISOString()\n    };\n    \n    await fs.writeFile(tokenUsageFile, JSON.stringify(initialData, null, 2));\n    printSuccess('  ‚úì Created token usage tracking file');\n    \n    // Add telemetry configuration to .claude/settings.json if it exists\n    const settingsPath = path.join(workingDir, '.claude', 'settings.json');\n    try {\n      const settingsContent = await fs.readFile(settingsPath, 'utf8');\n      const settings = JSON.parse(settingsContent);\n      \n      // Add telemetry hook\n      if (!settings.hooks) settings.hooks = {};\n      if (!settings.hooks['post-task']) settings.hooks['post-task'] = [];\n      \n      // Add token tracking hook\n      const tokenTrackingHook = 'npx claude-flow@alpha internal track-tokens --session-id {{session_id}} --tokens {{token_usage}}';\n      if (!settings.hooks['post-task'].includes(tokenTrackingHook)) {\n        settings.hooks['post-task'].push(tokenTrackingHook);\n      }\n      \n      await fs.writeFile(settingsPath, JSON.stringify(settings, null, 2));\n      printSuccess('  ‚úì Added token tracking hooks to settings');\n    } catch (err) {\n      console.log('  ‚ö†Ô∏è  Could not update settings.json:', err.message);\n    }\n    \n    // Create monitoring configuration\n    const monitoringConfig = {\n      enabled: true,\n      telemetry: {\n        claudeCode: {\n          env: 'CLAUDE_CODE_ENABLE_TELEMETRY',\n          value: '1',\n          description: 'Enable Claude Code OpenTelemetry metrics'\n        }\n      },\n      tracking: {\n        tokens: true,\n        costs: true,\n        agents: true,\n        sessions: true\n      },\n      storage: {\n        location: '.claude-flow@alpha/token-usage.json',\n        format: 'json',\n        rotation: 'monthly'\n      }\n    };\n    \n    const configPath = path.join(trackingDir, 'monitoring.config.json');\n    await fs.writeFile(configPath, JSON.stringify(monitoringConfig, null, 2));\n    printSuccess('  ‚úì Created monitoring configuration');\n    \n    // Create shell profile snippet for environment variable\n    const envSnippet = `\n# Claude Flow Token Tracking\n# Add this to your shell profile (.bashrc, .zshrc, etc.)\nexport CLAUDE_CODE_ENABLE_TELEMETRY=1\n\n# Optional: Set custom metrics path\n# export CLAUDE_METRICS_PATH=\"$HOME/.claude/metrics\"\n`;\n    \n    const envPath = path.join(trackingDir, 'env-setup.sh');\n    await fs.writeFile(envPath, envSnippet.trim());\n    printSuccess('  ‚úì Created environment setup script');\n    \n    console.log('\\n  üìã To enable Claude Code telemetry:');\n    console.log('     1. Add to your shell profile: export CLAUDE_CODE_ENABLE_TELEMETRY=1');\n    console.log('     2. Or run: source .claude-flow@alpha/env-setup.sh');\n    console.log('\\n  üí° Token usage will be tracked in .claude-flow@alpha/token-usage.json');\n    console.log('     Run: claude-flow@alpha analysis token-usage --breakdown --cost-analysis');\n    \n  } catch (err) {\n    printError(`  Failed to setup monitoring: ${err.message}`);\n  }\n}\n\n/**\n * Enhanced Claude Flow v2.0.0 initialization\n */\nasync function enhancedClaudeFlowInit(flags, subArgs = []) {\n  console.log('üöÄ Initializing Claude Flow v2.0.0 with enhanced features...');\n\n  const workingDir = process.cwd();\n  const force = flags.force || flags.f;\n  const dryRun = flags.dryRun || flags['dry-run'] || flags.d;\n  const initSparc = flags.roo || (subArgs && subArgs.includes('--roo')); // SPARC only with --roo flag\n\n  // Store parameters to avoid scope issues in async context\n  const args = subArgs || [];\n  const options = flags || {};\n\n  // Import fs module for Node.js\n  const fs = await import('fs/promises');\n  const { chmod } = fs;\n\n  try {\n    // Check existing files\n    const existingFiles = [];\n    const filesToCheck = [\n      'CLAUDE.md',\n      '.claude/settings.json',\n      '.mcp.json',\n      // Removed claude-flow@alpha.config.json per user request\n    ];\n\n    for (const file of filesToCheck) {\n      if (existsSync(`${workingDir}/${file}`)) {\n        existingFiles.push(file);\n      }\n    }\n\n    if (existingFiles.length > 0 && !force) {\n      printWarning(`The following files already exist: ${existingFiles.join(', ')}`);\n      console.log('Use --force to overwrite existing files');\n      return;\n    }\n\n    // Create CLAUDE.md\n    if (!dryRun) {\n      await fs.writeFile(`${workingDir}/CLAUDE.md`, createOptimizedSparcClaudeMd(), 'utf8');\n      printSuccess('‚úì Created CLAUDE.md (Claude Flow v2.0.0 - Optimized)');\n    } else {\n      console.log('[DRY RUN] Would create CLAUDE.md (Claude Flow v2.0.0 - Optimized)');\n    }\n\n    // Create .claude directory structure\n    const claudeDir = `${workingDir}/.claude`;\n    if (!dryRun) {\n      await fs.mkdir(claudeDir, { recursive: true });\n      await fs.mkdir(`${claudeDir}/commands`, { recursive: true });\n      await fs.mkdir(`${claudeDir}/helpers`, { recursive: true });\n      printSuccess('‚úì Created .claude directory structure');\n    } else {\n      console.log('[DRY RUN] Would create .claude directory structure');\n    }\n\n    // Create settings.json\n    if (!dryRun) {\n      await fs.writeFile(`${claudeDir}/settings.json`, createEnhancedSettingsJson(), 'utf8');\n      printSuccess('‚úì Created .claude/settings.json with hooks and MCP configuration');\n    } else {\n      console.log('[DRY RUN] Would create .claude/settings.json');\n    }\n\n    // Create settings.local.json with default MCP permissions\n    const settingsLocal = {\n      permissions: {\n        allow: ['mcp__ruv-swarm', 'mcp__claude-flow@alpha', 'mcp__flow-nexus'],\n        deny: [],\n      },\n    };\n\n    if (!dryRun) {\n      await fs.writeFile(\n        `${claudeDir}/settings.local.json`, JSON.stringify(settingsLocal, null, 2, 'utf8'),\n      );\n      printSuccess('‚úì Created .claude/settings.local.json with default MCP permissions');\n    } else {\n      console.log(\n        '[DRY RUN] Would create .claude/settings.local.json with default MCP permissions',\n      );\n    }\n\n    // Create .mcp.json at project root for MCP server configuration\n    const mcpConfig = {\n      mcpServers: {\n        'claude-flow@alpha': {\n          command: 'npx',\n          args: ['claude-flow@alpha', 'mcp', 'start'],\n          type: 'stdio',\n        },\n        'ruv-swarm': {\n          command: 'npx',\n          args: ['ruv-swarm@latest', 'mcp', 'start'],\n          type: 'stdio',\n        },\n        'flow-nexus': {\n          command: 'npx',\n          args: ['flow-nexus@latest', 'mcp', 'start'],\n          type: 'stdio',\n        },\n      },\n    };\n\n    if (!dryRun) {\n      await fs.writeFile(`${workingDir}/.mcp.json`, JSON.stringify(mcpConfig, null, 2, 'utf8'));\n      printSuccess('‚úì Created .mcp.json at project root for MCP server configuration');\n    } else {\n      console.log('[DRY RUN] Would create .mcp.json at project root for MCP server configuration');\n    }\n\n    // Removed claude-flow@alpha.config.json creation per user request\n\n    // Create command documentation\n    for (const [category, commands] of Object.entries(COMMAND_STRUCTURE)) {\n      const categoryDir = `${claudeDir}/commands/${category}`;\n\n      if (!dryRun) {\n        await fs.mkdir(categoryDir, { recursive: true });\n\n        // Create category README\n        const categoryReadme = `# ${category.charAt(0).toUpperCase() + category.slice(1)} Commands\n\nCommands for ${category} operations in Claude Flow.\n\n## Available Commands\n\n${commands.map((cmd) => `- [${cmd}](./${cmd}.md)`).join('\\n')}\n`;\n        await fs.writeFile(`${categoryDir}/README.md`, categoryReadme, 'utf8');\n\n        // Create individual command docs\n        for (const command of commands) {\n          const doc = createCommandDoc(category, command);\n          if (doc) {\n            await fs.writeFile(`${categoryDir}/${command}.md`, doc, 'utf8');\n          }\n        }\n\n        console.log(`  ‚úì Created ${commands.length} ${category} command docs`);\n      } else {\n        console.log(`[DRY RUN] Would create ${commands.length} ${category} command docs`);\n      }\n    }\n\n    // Create wrapper scripts using the dedicated function\n    if (!dryRun) {\n      await createLocalExecutable(workingDir, dryRun);\n    } else {\n      console.log('[DRY RUN] Would create wrapper scripts');\n    }\n\n    // Create helper scripts\n    const helpers = ['setup-mcp.sh', 'quick-start.sh', 'github-setup.sh', 'github-safe.js', 'standard-checkpoint-hooks.sh', 'checkpoint-manager.sh'];\n    for (const helper of helpers) {\n      if (!dryRun) {\n        const content = createHelperScript(helper);\n        if (content) {\n          await fs.writeFile(`${claudeDir}/helpers/${helper}`, content, 'utf8');\n          await fs.chmod(`${claudeDir}/helpers/${helper}`, 0o755);\n        }\n      }\n    }\n\n    if (!dryRun) {\n      printSuccess(`‚úì Created ${helpers.length} helper scripts`);\n    } else {\n      console.log(`[DRY RUN] Would create ${helpers.length} helper scripts`);\n    }\n\n    // Create standard directories from original init\n    const standardDirs = [\n      'memory',\n      'memory/agents',\n      'memory/sessions',\n      'coordination',\n      'coordination/memory_bank',\n      'coordination/subtasks',\n      'coordination/orchestration',\n      '.swarm', // Add .swarm directory for shared memory\n      '.hive-mind', // Add .hive-mind directory for hive-mind system\n      '.claude/checkpoints', // Add checkpoints directory for Git checkpoint system\n    ];\n\n    for (const dir of standardDirs) {\n      if (!dryRun) {\n        await fs.mkdir(`${workingDir}/${dir}`, { recursive: true });\n      }\n    }\n\n    if (!dryRun) {\n      printSuccess('‚úì Created standard directory structure');\n\n      // Initialize memory system\n      const initialData = { agents: [], tasks: [], lastUpdated: Date.now() };\n      await fs.writeFile(\n        `${workingDir}/memory/claude-flow@alpha-data.json`, JSON.stringify(initialData, null, 2, 'utf8'),\n      );\n\n      // Create README files\n      await fs.writeFile(`${workingDir}/memory/agents/README.md`, createAgentsReadme(), 'utf8');\n      await fs.writeFile(`${workingDir}/memory/sessions/README.md`, createSessionsReadme(), 'utf8');\n\n      printSuccess('‚úì Initialized memory system');\n\n      // Initialize memory database with fallback support\n      try {\n        // Import and initialize FallbackMemoryStore to create the database\n        const { FallbackMemoryStore } = await import('../../../memory/fallback-store.js');\n        const memoryStore = new FallbackMemoryStore();\n        await memoryStore.initialize();\n\n        if (memoryStore.isUsingFallback()) {\n          printSuccess('‚úì Initialized memory system (in-memory fallback for npx compatibility)');\n          console.log(\n            '  üí° For persistent storage, install locally: npm install claude-flow@alpha',\n          );\n        } else {\n          printSuccess('‚úì Initialized memory database (.swarm/memory.db)');\n        }\n\n        memoryStore.close();\n      } catch (err) {\n        console.log(`  ‚ö†Ô∏è  Could not initialize memory system: ${err.message}`);\n        console.log('     Memory will be initialized on first use');\n      }\n\n      // Initialize comprehensive hive-mind system\n      console.log('\\nüß† Initializing Hive Mind System...');\n      try {\n        const hiveMindOptions = {\n          config: {\n            integration: {\n              claudeCode: { enabled: isClaudeCodeInstalled() },\n              mcpTools: { enabled: true }\n            },\n            monitoring: { enabled: flags.monitoring || false }\n          }\n        };\n        \n        const hiveMindResult = await initializeHiveMind(workingDir, hiveMindOptions, dryRun);\n        \n        if (hiveMindResult.success) {\n          printSuccess(`‚úì Hive Mind System initialized with ${hiveMindResult.features.length} features`);\n          \n          // Log individual features\n          hiveMindResult.features.forEach(feature => {\n            console.log(`    ‚Ä¢ ${feature}`);\n          });\n        } else {\n          console.log(`  ‚ö†Ô∏è  Hive Mind initialization failed: ${hiveMindResult.error}`);\n          if (hiveMindResult.rollbackRequired) {\n            console.log('  üîÑ Automatic rollback may be required');\n          }\n        }\n      } catch (err) {\n        console.log(`  ‚ö†Ô∏è  Could not initialize hive-mind system: ${err.message}`);\n      }\n    }\n\n    // Update .gitignore with Claude Flow entries\n    const gitignoreResult = await updateGitignore(workingDir, force, dryRun);\n    if (gitignoreResult.success) {\n      if (!dryRun) {\n        printSuccess(`‚úì ${gitignoreResult.message}`);\n      } else {\n        console.log(gitignoreResult.message);\n      }\n    } else {\n      console.log(`  ‚ö†Ô∏è  ${gitignoreResult.message}`);\n    }\n\n    // SPARC initialization (only with --roo flag)\n    let sparcInitialized = false;\n    if (initSparc) {\n      console.log('\\nüöÄ Initializing SPARC development environment...');\n      try {\n        // Run create-sparc\n        console.log('  üîÑ Running: npx -y create-sparc init --force');\n        execSync('npx -y create-sparc init --force', {\n          cwd: workingDir,\n          stdio: 'inherit',\n        });\n        sparcInitialized = true;\n        printSuccess('‚úÖ SPARC environment initialized successfully');\n      } catch (err) {\n        console.log(`  ‚ö†Ô∏è  Could not run create-sparc: ${err.message}`);\n        console.log('     SPARC features will be limited to basic functionality');\n      }\n    }\n\n    // Create Claude slash commands for SPARC\n    if (sparcInitialized && !dryRun) {\n      console.log('\\nüìù Creating Claude Code slash commands...');\n      await createClaudeSlashCommands(workingDir);\n    }\n\n    // Check for Claude Code and set up MCP servers (always enabled by default)\n    if (!dryRun && isClaudeCodeInstalled()) {\n      console.log('\\nüîç Claude Code CLI detected!');\n      const skipMcp =\n        (options && options['skip-mcp']) ||\n        (subArgs && subArgs.includes && subArgs.includes('--skip-mcp'));\n\n      if (!skipMcp) {\n        await setupMcpServers(dryRun);\n      } else {\n        console.log('  ‚ÑπÔ∏è  Skipping MCP setup (--skip-mcp flag used)');\n        console.log('\\n  üìã To add MCP servers manually:');\n        console.log('     claude mcp add claude-flow npx claude-flow@alpha mcp start');\n        console.log('     claude mcp add ruv-swarm npx ruv-swarm@latest mcp start');\n        console.log('     claude mcp add flow-nexus npx flow-nexus@latest mcp start');\n        console.log('\\n  üí° MCP servers are defined in .mcp.json (project scope)');\n      }\n    } else if (!dryRun && !isClaudeCodeInstalled()) {\n      console.log('\\n‚ö†Ô∏è  Claude Code CLI not detected!');\n      console.log('\\n  üì• To install Claude Code:');\n      console.log('     npm install -g @anthropic-ai/claude-code');\n      console.log('\\n  üìã After installing, add MCP servers:');\n      console.log('     claude mcp add claude-flow@alpha npx claude-flow@alpha mcp start');\n      console.log('     claude mcp add ruv-swarm npx ruv-swarm@latest mcp start');\n      console.log('     claude mcp add flow-nexus npx flow-nexus@latest mcp start');\n      console.log('\\n  üí° MCP servers are defined in .mcp.json (project scope)');\n    }\n\n    // Create agent directories and copy all agent files\n    console.log('\\nü§ñ Setting up agent system...');\n    if (!dryRun) {\n      await createAgentDirectories(workingDir, dryRun);\n      const agentResult = await copyAgentFiles(workingDir, {\n        force: force,\n        dryRun: dryRun\n      });\n      \n      if (agentResult.success) {\n        await validateAgentSystem(workingDir);\n        \n        // Copy command files including Flow Nexus commands\n        console.log('\\nüìö Setting up command system...');\n        const commandResult = await copyCommandFiles(workingDir, {\n          force: force,\n          dryRun: dryRun\n        });\n        \n        if (commandResult.success) {\n          console.log('‚úÖ ‚úì Command system setup complete with Flow Nexus integration');\n        } else {\n          console.log('‚ö†Ô∏è  Command system setup failed:', commandResult.error);\n        }\n        \n        console.log('‚úÖ ‚úì Agent system setup complete with 64 specialized agents');\n      } else {\n        console.log('‚ö†Ô∏è  Agent system setup failed:', agentResult.error);\n      }\n    } else {\n      console.log('  [DRY RUN] Would create agent system with 64 specialized agents');\n    }\n\n    // Optional: Setup monitoring and telemetry\n    const enableMonitoring = flags.monitoring || flags['enable-monitoring'];\n    if (enableMonitoring && !dryRun) {\n      console.log('\\nüìä Setting up monitoring and telemetry...');\n      await setupMonitoring(workingDir);\n    }\n    \n    // Final instructions with hive-mind status\n    console.log('\\nüéâ Claude Flow v2.0.0 initialization complete!');\n    \n    // Display hive-mind status\n    const hiveMindStatus = getHiveMindStatus(workingDir);\n    console.log('\\nüß† Hive Mind System Status:');\n    console.log(`  Configuration: ${hiveMindStatus.configured ? '‚úÖ Ready' : '‚ùå Missing'}`);\n    console.log(`  Database: ${hiveMindStatus.database === 'sqlite' ? '‚úÖ SQLite' : hiveMindStatus.database === 'fallback' ? '‚ö†Ô∏è JSON Fallback' : '‚ùå Not initialized'}`);\n    console.log(`  Directory Structure: ${hiveMindStatus.directories ? '‚úÖ Created' : '‚ùå Missing'}`);\n    \n    console.log('\\nüìö Quick Start:');\n    if (isClaudeCodeInstalled()) {\n      console.log('1. View available commands: ls .claude/commands/');\n      console.log('2. Start a swarm: npx claude-flow@alpha swarm \"your objective\" --claude');\n      console.log('3. Use hive-mind: npx claude-flow@alpha hive-mind spawn \"command\" --claude');\n      console.log('4. Use MCP tools in Claude Code for enhanced coordination');\n      if (hiveMindStatus.configured) {\n        console.log('5. Initialize first swarm: npx claude-flow@alpha hive-mind init');\n      }\n    } else {\n      console.log('1. Install Claude Code: npm install -g @anthropic-ai/claude-code');\n      console.log('2. Add MCP servers (see instructions above)');\n      console.log('3. View available commands: ls .claude/commands/');\n      console.log('4. Start a swarm: npx claude-flow@alpha swarm \"your objective\" --claude');\n      console.log('5. Use hive-mind: npx claude-flow@alpha hive-mind spawn \"command\" --claude');\n      if (hiveMindStatus.configured) {\n        console.log('6. Initialize first swarm: npx claude-flow@alpha hive-mind init');\n      }\n    }\n    console.log('\\nüí° Tips:');\n    console.log('‚Ä¢ Check .claude/commands/ for detailed documentation');\n    console.log('‚Ä¢ Use --help with any command for options');\n    console.log('‚Ä¢ Run commands with --claude flag for best Claude Code integration');\n    console.log('‚Ä¢ Enable GitHub integration with .claude/helpers/github-setup.sh');\n    console.log('‚Ä¢ Git checkpoints are automatically enabled in settings.json');\n    console.log('‚Ä¢ Use .claude/helpers/checkpoint-manager.sh for easy rollback');\n  } catch (err) {\n    printError(`Failed to initialize Claude Flow v2.0.0: ${err.message}`);\n    \n    // Attempt hive-mind rollback if it was partially initialized\n    try {\n      const hiveMindStatus = getHiveMindStatus(workingDir);\n      if (hiveMindStatus.directories || hiveMindStatus.configured) {\n        console.log('\\nüîÑ Attempting hive-mind system rollback...');\n        const rollbackResult = await rollbackHiveMindInit(workingDir);\n        if (rollbackResult.success) {\n          console.log('  ‚úÖ Hive-mind rollback completed');\n        } else {\n          console.log(`  ‚ö†Ô∏è  Hive-mind rollback failed: ${rollbackResult.error}`);\n        }\n      }\n    } catch (rollbackErr) {\n      console.log(`  ‚ö†Ô∏è  Rollback error: ${rollbackErr.message}`);\n    }\n  }\n}\n\n/**\n * Flow Nexus minimal initialization - only creates Flow Nexus CLAUDE.md, commands, and agents\n */\nasync function flowNexusMinimalInit(flags, subArgs) {\n  console.log('üåê Flow Nexus: Initializing minimal setup...');\n  \n  try {\n    const force = flags.force || flags.f;\n    \n    // Import functions we need\n    const { createFlowNexusClaudeMd } = await import('./templates/claude-md.js');\n    const { promises: fs } = await import('fs');\n    \n    // Create Flow Nexus CLAUDE.md\n    console.log('üìù Creating Flow Nexus CLAUDE.md...');\n    const flowNexusClaudeMd = createFlowNexusClaudeMd();\n    await fs.writeFile('CLAUDE.md', flowNexusClaudeMd);\n    console.log('  ‚úÖ Created CLAUDE.md with Flow Nexus integration');\n    \n    // Create .claude/commands/flow-nexus directory and copy commands\n    console.log('üìÅ Setting up Flow Nexus commands...');\n    await fs.mkdir('.claude/commands/flow-nexus', { recursive: true });\n    \n    // Copy Flow Nexus command files\n    const { fileURLToPath } = await import('url');\n    const { dirname, join } = await import('path');\n    const __filename = fileURLToPath(import.meta.url);\n    const __dirname = dirname(__filename);\n    const sourceCommandsDir = join(__dirname, '../../../../.claude/commands/flow-nexus');\n    try {\n      const commandFiles = await fs.readdir(sourceCommandsDir);\n      let copiedCommands = 0;\n      \n      for (const file of commandFiles) {\n        if (file.endsWith('.md')) {\n          const sourcePath = `${sourceCommandsDir}/${file}`;\n          const destPath = `.claude/commands/flow-nexus/${file}`;\n          const content = await fs.readFile(sourcePath, 'utf8');\n          await fs.writeFile(destPath, content);\n          copiedCommands++;\n        }\n      }\n      \n      console.log(`  ‚úÖ Copied ${copiedCommands} Flow Nexus command files`);\n    } catch (err) {\n      console.log('  ‚ö†Ô∏è  Could not copy Flow Nexus commands:', err.message);\n    }\n    \n    // Create .claude/agents/flow-nexus directory and copy agents\n    console.log('ü§ñ Setting up Flow Nexus agents...');\n    await fs.mkdir('.claude/agents/flow-nexus', { recursive: true });\n    \n    // Copy Flow Nexus agent files\n    const sourceAgentsDir = join(__dirname, '../../../../.claude/agents/flow-nexus');\n    try {\n      const agentFiles = await fs.readdir(sourceAgentsDir);\n      let copiedAgents = 0;\n      \n      for (const file of agentFiles) {\n        if (file.endsWith('.md')) {\n          const sourcePath = `${sourceAgentsDir}/${file}`;\n          const destPath = `.claude/agents/flow-nexus/${file}`;\n          const content = await fs.readFile(sourcePath, 'utf8');\n          await fs.writeFile(destPath, content);\n          copiedAgents++;\n        }\n      }\n      \n      console.log(`  ‚úÖ Copied ${copiedAgents} Flow Nexus agent files`);\n    } catch (err) {\n      console.log('  ‚ö†Ô∏è  Could not copy Flow Nexus agents:', err.message);\n    }\n    \n    console.log('\\nüéâ Flow Nexus minimal initialization complete!');\n    console.log('üìö Created: CLAUDE.md with Flow Nexus documentation');\n    console.log('üìÅ Created: .claude/commands/flow-nexus/ directory with command documentation');\n    console.log('ü§ñ Created: .claude/agents/flow-nexus/ directory with specialized agents');\n    console.log('');\n    console.log('üí° Quick Start:');\n    console.log('  1. Register: mcp__flow-nexus__user_register({ email, password })');\n    console.log('  2. Login: mcp__flow-nexus__user_login({ email, password })');\n    console.log('  3. Deploy: mcp__flow-nexus__swarm_init({ topology: \"mesh\", maxAgents: 5 })');\n    console.log('');\n    console.log('üîó Use Flow Nexus MCP tools in Claude Code for full functionality');\n    \n  } catch (err) {\n    console.log(`‚ùå Flow Nexus initialization failed: ${err.message}`);\n    console.log('Stack trace:', err.stack);\n    process.exit(1);\n  }\n}\n"],"names":["printSuccess","printError","printWarning","existsSync","process","spawn","execSync","runCommand","command","args","options","Promise","resolve","reject","child","cwd","env","stdio","stdout","stderr","on","data","code","success","Error","createLocalExecutable","createSparcStructureManually","createClaudeSlashCommands","createOptimizedClaudeSlashCommands","promises","fs","copyTemplates","copyRevisedTemplates","validateTemplatesExist","copyAgentFiles","createAgentDirectories","validateAgentSystem","copyCommandFiles","showInitHelp","batchInitCommand","batchInitFromConfig","validateBatchOptions","ValidationSystem","runFullValidation","RollbackSystem","createAtomicOperation","createEnhancedSettingsJson","createCommandDoc","createHelperScript","COMMAND_STRUCTURE","createOptimizedSparcClaudeMd","getIsolatedNpxEnv","updateGitignore","createFullClaudeMd","createSparcClaudeMd","createMinimalClaudeMd","createFullMemoryBankMd","createMinimalMemoryBankMd","createFullCoordinationMd","createMinimalCoordinationMd","createAgentsReadme","createSessionsReadme","initializeHiveMind","getHiveMindStatus","rollbackHiveMindInit","isClaudeCodeInstalled","setupMcpServers","dryRun","console","log","servers","name","description","server","err","message","initCommand","subArgs","flags","help","h","includes","hasVerificationFlags","verify","pair","flowNexusMinimalInit","basic","minimal","sparc","enhancedClaudeFlowInit","handleValidationCommand","handleRollbackCommand","handleListBackups","batchInitFlag","configFlag","config","handleBatchInit","useEnhanced","enhancedInitCommand","initForce","force","initMinimal","initSparc","roo","initDryRun","initOptimized","selectedModes","modes","split","initVerify","initPair","workingDir","PWD","chdir","files","existingFiles","file","stat","push","length","join","templateOptions","optimized","createVerificationClaudeMd","createVerificationSettingsJson","writeFile","mkdir","recursive","validation","valid","revisedResults","verbose","copyResults","skipClaudeMd","skipSettings","copiedFiles","skippedFiles","errors","forEach","sparcInitialized","createSparcResult","modeCount","gitignoreResult","hiveMindOptions","integration","claudeCode","enabled","mcpTools","monitoring","hiveMindResult","error","skipMcp","parallel","s","m","f","maxConcurrency","progressTracking","template","environments","map","trim","validationErrors","configFile","results","projectsString","projects","project","successful","filter","r","failed","rollbackSystem","validationSystem","atomicOp","initOptions","skipPreValidation","skipBackup","validateOnly","preValidation","validatePreInit","warnings","warning","warn","backupResult","createPreInitBackup","atomicBegin","begin","performInitializationWithCheckpoints","postValidation","validatePostInit","rollback","configValidation","validateConfiguration","healthChecks","runHealthChecks","commit","fullValidation","postInit","skipPreInit","report","completed","rollbackError","skipConfig","skipModeTest","validationResults","exit","result","performFullRollback","phaseIndex","findIndex","arg","phase","performPartialRollback","rollbackPoints","listRollbackPoints","point","index","date","Date","timestamp","toLocaleString","type","latest","backupId","checkpoints","slice","checkpoint","status","phases","action","createInitialFiles","createDirectoryStructure","setupMemorySystem","setupCoordinationSystem","createCheckpoint","now","claudeMd","memoryBankMd","coordinationMd","directories","dir","initialData","agents","tasks","lastUpdated","JSON","stringify","setupMonitoring","path","trackingDir","tokenUsageFile","total","input","output","byAgent","toISOString","settingsPath","settingsContent","readFile","settings","parse","hooks","tokenTrackingHook","monitoringConfig","telemetry","value","tracking","tokens","costs","sessions","storage","location","format","rotation","configPath","envSnippet","envPath","d","chmod","filesToCheck","claudeDir","settingsLocal","permissions","allow","deny","mcpConfig","mcpServers","category","commands","Object","entries","categoryDir","categoryReadme","charAt","toUpperCase","cmd","doc","helpers","helper","content","standardDirs","FallbackMemoryStore","memoryStore","initialize","isUsingFallback","close","features","feature","rollbackRequired","agentResult","commandResult","enableMonitoring","hiveMindStatus","configured","database","rollbackResult","rollbackErr","createFlowNexusClaudeMd","flowNexusClaudeMd","fileURLToPath","dirname","__filename","url","__dirname","sourceCommandsDir","commandFiles","readdir","copiedCommands","endsWith","sourcePath","destPath","sourceAgentsDir","agentFiles","copiedAgents","stack"],"mappings":"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"}